<!-- Contenedor flotante con UI completa -->
<div class="fixed bottom-4 right-4 z-50 transition-all duration-300"
     [class.w-80]="!minimizado()"
     [class.w-auto]="minimizado()">
  
  <!-- Elementos de video y canvas - Siempre presentes (ocultos cuando minimizado) -->
  <video #video autoplay playsinline [class.hidden]="true"></video>
  <canvas #canvas class="hidden"></canvas>
  
  <!-- Mensaje de error -->
  @if (error()) {
    <div class="bg-red-50 border border-red-200 rounded-lg p-3 flex items-start shadow-lg">
      <svg class="h-4 w-4 text-red-600 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p class="text-xs text-red-800">{{ error() }}</p>
    </div>
  }

  <!-- Mostrar vista solo si la cámara está lista (permisos aceptados) -->
  @if (cameraReady() && !error()) {
    <!-- Vista minimizada - Solo botón -->
    @if (minimizado()) {
      <div class="bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-2xl cursor-pointer p-4 flex items-center gap-2"
          (click)="toggleMinimizar()">
        @if (procesando() || estadoCaptura() === 'capturando') {
          <div class="w-6 h-6 animate-spin rounded-full border-b-2 border-white"></div>
        } @else {
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            @if (estadoCaptura() === 'quietud'){
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7.5 3.75H6A2.25 2.25 0 0 0 3.75 6v1.5M16.5 3.75H18A2.25 2.25 0 0 1 20.25 6v1.5m0 9V18A2.25 2.25 0 0 1 18 20.25h-1.5m-9 0H6A2.25 2.25 0 0 1 3.75 18v-1.5M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
            } @else {
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            }
          </svg>
        }
      </div>
    }
    <!-- Vista expandida - UI completa -->
    @if (!minimizado()) {
      <div class="bg-white rounded-lg shadow-2xl border-2 border-blue-500">
        <div class="p-3">
          <!-- Header -->
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <!-- Estado de procesamiento -->
              @if (procesando() || estadoCaptura() === 'capturando') {
                <div class="animate-spin 
                rounded-full w-5 h-5 border-b-2 border-blue-600"></div>
              } @else {
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  @if (estadoCaptura() === 'quietud'){
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7.5 3.75H6A2.25 2.25 0 0 0 3.75 6v1.5M16.5 3.75H18A2.25 2.25 0 0 1 20.25 6v1.5m0 9V18A2.25 2.25 0 0 1 18 20.25h-1.5m-9 0H6A2.25 2.25 0 0 1 3.75 18v-1.5M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                  } @else {
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  }
                </svg>
              }
              <h3 class="text-sm font-semibold text-gray-900">Reconocimiento Facial</h3>
            </div>
            <div class="flex items-center gap-2">
              <!-- Botón minimizar -->
              <button
                type="button" 
                (click)="toggleMinimizar()"
                class="text-gray-400 hover:text-gray-600 transition-colors"
                title="Minimizar (sigue activo)"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                </svg>
              </button> 
              <!-- Botón cerrar -->
              <button
                type="button"
                (click)="cerrar()"
                class="text-gray-400 hover:text-gray-600 transition-colors"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>

          <!-- Vista de cámara - Copia visual del video oculto -->
          <div class="relative">
            <div class="w-full rounded-lg bg-black overflow-hidden" style="aspect-ratio: 4/3;">
              <!-- Mostrar el stream usando CSS para duplicar el video oculto -->
              <div class="w-full h-full relative">
                <!-- Espejo del video (se actualiza desde el video oculto) -->
                <canvas #displayCanvas class="w-full h-full"></canvas>
                <!-- Guía visual -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                  <div class="border-4 border-green-400 border-dashed rounded-full opacity-50 aspect-square"
                      style="height: 90%;"></div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    }
  }
</div>