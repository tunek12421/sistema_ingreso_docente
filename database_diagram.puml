@startuml Database Schema - Sistema de Ingreso Docente

!define TABLE(x) class x << (T,#FFAAAA) >>
!define PK(x) <b><color:red>x</color></b>
!define FK(x) <color:blue>x</color>

' Configuración del diagrama
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 80

' ==================== TABLAS ====================

TABLE(usuarios) {
  PK(id): SERIAL
  --
  username: VARCHAR(100) UNIQUE
  password: VARCHAR(255)
  rol: VARCHAR(50)
  activo: BOOLEAN
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
}

TABLE(docentes) {
  PK(id): SERIAL
  --
  FK(usuario_id): INTEGER UNIQUE
  documento_identidad: BIGINT UNIQUE
  nombre_completo: VARCHAR(255)
  correo: VARCHAR(255) UNIQUE
  telefono: BIGINT
  activo: BOOLEAN
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
}

TABLE(turnos) {
  PK(id): SERIAL
  --
  nombre: VARCHAR(100) UNIQUE
  hora_inicio: TIME
  hora_fin: TIME
  descripcion: TEXT
  activo: BOOLEAN
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
}

TABLE(ambientes_academicos) {
  PK(id): SERIAL
  --
  codigo: VARCHAR(50) UNIQUE
  descripcion: VARCHAR(255)
  tipo_ambiente: VARCHAR(50)
  capacidad: INTEGER
  piso: INTEGER
  edificio: VARCHAR(50)
  activo: BOOLEAN
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
}

TABLE(llaves) {
  PK(id): SERIAL
  --
  codigo: VARCHAR(50) UNIQUE
  FK(ambiente_id): INTEGER
  estado: VARCHAR(20)
  descripcion: TEXT
  activo: BOOLEAN
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
}

TABLE(asignaciones_docente) {
  PK(id): SERIAL
  --
  FK(docente_id): INTEGER
  FK(turno_id): INTEGER
  FK(ambiente_id): INTEGER
  FK(llave_id): INTEGER
  fecha_inicio: DATE
  fecha_fin: DATE
  activo: BOOLEAN
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
}

TABLE(registros) {
  PK(id): SERIAL
  --
  FK(docente_id): INTEGER
  FK(ambiente_id): INTEGER
  FK(turno_id): INTEGER
  FK(llave_id): INTEGER
  tipo: VARCHAR(10)
  fecha_hora: TIMESTAMP
  minutos_retraso: INTEGER
  minutos_extra: INTEGER
  observaciones: TEXT
  FK(editado_por): INTEGER
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
}

' ==================== RELACIONES ====================

' Usuario -> Docente (1:1)
usuarios "1" -- "0..1" docentes : tiene >

' Ambiente -> Llaves (1:N)
ambientes_academicos "1" -- "0..*" llaves : posee >

' Docente -> Asignaciones (1:N)
docentes "1" -- "0..*" asignaciones_docente : tiene >

' Turno -> Asignaciones (1:N)
turnos "1" -- "0..*" asignaciones_docente : define >

' Ambiente -> Asignaciones (1:N)
ambientes_academicos "1" -- "0..*" asignaciones_docente : aloja >

' Llave -> Asignaciones (1:N)
llaves "1" -- "0..*" asignaciones_docente : asignada a >

' Docente -> Registros (1:N)
docentes "1" -- "0..*" registros : registra >

' Ambiente -> Registros (1:N)
ambientes_academicos "1" -- "0..*" registros : lugar de >

' Turno -> Registros (1:N)
turnos "1" -- "0..*" registros : durante >

' Llave -> Registros (1:N)
llaves "1" -- "0..*" registros : usa >

' Usuario -> Registros (1:N) - editado_por
usuarios "1" -- "0..*" registros : edita >

' ==================== NOTAS ====================

note right of usuarios
  <b>Roles disponibles:</b>
  - jefe_carrera
  - bibliotecario
  - docente

  <b>Password:</b>
  Hash bcrypt
end note

note right of llaves
  <b>Estados disponibles:</b>
  - disponible
  - en_uso
  - extraviada
  - inactiva
end note

note right of registros
  <b>Tipos:</b>
  - ingreso
  - salida

  <b>Cálculo automático:</b>
  - minutos_retraso
  - minutos_extra
end note

note bottom of asignaciones_docente
  <b>Constraint único:</b>
  (docente_id, turno_id,
   ambiente_id, fecha_inicio)

  <b>Vigencia:</b>
  fecha_inicio -> fecha_fin
end note

@enduml
